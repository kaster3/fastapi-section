services:
    app:
      container_name: app
      build:
        dockerfile: Dockerfile
      command:
        - sh
        - -c
        - |
          alembic -c app/alembic.ini upgrade head &&
          python app/main.py
      restart: always
      ports:
        - "8000:8000"
      depends_on:
        db:
          condition: service_healthy
        cache:
          condition: service_healthy

    db:
      image: postgres:16.2
      container_name: db
      restart: always
      env_file:
        - .template.env.docker
      volumes:
        - db:/var/lib/postgresql/data
      healthcheck:
        test: [ "CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}" ]
        interval: 2s
        timeout: 5s
        retries: 5

    cache:
      container_name: cache
      image: redis:latest
      restart: always
      healthcheck:
        test: [ "CMD", "redis-cli", "ping" ]
        interval: 5s
        timeout: 3s
        retries: 3
      volumes:
        - redis_data:/data

volumes:
  db:
    driver: local
  redis_data:
    driver: local
